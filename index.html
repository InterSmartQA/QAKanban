<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QA Team Kanban Board</title>
  <!-- Load external libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" 
          crossorigin="anonymous" 
          onerror="handleScriptLoadError('Chart.js')"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" 
          crossorigin="anonymous" 
          onerror="handleScriptLoadError('XLSX')"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.css" 
        crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js" 
          crossorigin="anonymous" 
          onerror="handleScriptLoadError('Flatpickr')"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" 
          crossorigin="anonymous" 
          onerror="handleScriptLoadError('Supabase')"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" 
        crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a4971;
      --secondary: #2a9d8f;
      --accent: #e76f51;
      --background: #f8fafc;
      --text: #1e293b;
      --border: #e2e8f0;
      --hover: #edf2f7;
      --overdue: #fee2e2;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background);
      color: var(--text);
      line-height: 1.6;
    }

    header {
      display: flex;
      align-items: center;
      background: linear-gradient(90deg, var(--primary), #2b6cb0);
      padding: 15px 30px;
      color: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header img {
      height: 50px;
      margin-right: 20px;
    }

    header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .container {
      max-width: 1440px;
      margin: 30px auto;
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .error-message {
      color: #dc2626;
      margin: 15px 0;
      font-weight: 500;
      text-align: center;
    }

    .error-message.hidden {
      display: none;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      align-items: center;
    }

    .controls select,
    .controls input,
    .controls button,
    .controls textarea {
      padding: 12px 16px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      transition: all 0.2s ease;
      min-width: 200px;
    }

    .controls textarea {
      resize: vertical;
      min-height: 100px;
    }

    .controls select:focus,
    .controls input:focus,
    .controls textarea:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(42, 157, 143, 0.1);
    }

    .controls button {
      background-color: var(--secondary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 500;
    }

    .controls button:hover {
      background-color: #21867a;
      transform: translateY(-1px);
    }

    .reset-btn {
      background-color: var(--accent);
    }

    .reset-btn:hover {
      background-color: #d65f43;
    }

    .kanban-board {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .kanban-column {
      flex: 1;
      min-width: 250px;
      background: #f1f5f9;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border);
    }

    .kanban-column h3 {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 15px;
      text-align: center;
    }

    .kanban-row {
      margin-bottom: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .kanban-row h4 {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 10px;
    }

    .kanban-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: move;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s ease;
    }

    .kanban-card:hover {
      transform: translateY(-2px);
    }

    .kanban-card.dragging {
      opacity: 0.5;
      transform: scale(0.98);
    }

    .kanban-card p {
      font-size: 13px;
      margin: 5px 0;
      color: var(--text);
    }

    .kanban-column.date-column .kanban-card {
      cursor: default;
    }

    .kanban-column.dropzone {
      background: rgba(42, 157, 143, 0.1);
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
      max-height: 600px;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      min-width: 1200px;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 14px;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background-color: var(--primary);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
      font-weight: 600;
    }

    td {
      background-color: white;
    }

    tr:nth-child(even) td {
      background-color: #f9fafb;
    }

    tr:hover td {
      background-color: var(--hover);
    }

    tr.active td {
      background-color: rgba(42, 157, 143, 0.1);
    }

    td.overdue {
      background-color: var(--overdue);
    }

    canvas {
      margin-top: 40px;
      max-width: 100%;
      border-radius: 8px;
      background: white;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .report-section {
      margin-top: 30px;
      padding: 20px;
      background-color: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .report-section h3 {
      color: var(--primary);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
    }

    .edit-btn, .delete-btn, .save-btn, .cancel-btn {
      color: white;
      border: none;
      padding: 8px;
      cursor: pointer;
      border-radius: 6px;
      margin-right: 8px;
      font-size: 14px;
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      transition: all 0.2s ease;
    }

    .edit-btn {
      background-color: #3b82f6;
    }

    .edit-btn:hover {
      background-color: #2563eb;
    }

    .delete-btn {
      background-color: #ef4444;
    }

    .delete-btn:hover {
      background-color: #dc2626;
    }

    .save-btn {
      background-color: #10b981;
    }

    .save-btn:hover {
      background-color: #059669;
    }

    .cancel-btn {
      background-color: #6b7280;
    }

    .cancel-btn:hover {
      background-color: #4b5563;
    }

    .edit-btn::after, .delete-btn::after, .save-btn::after, .cancel-btn::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
    }

    .edit-btn:hover::after, .delete-btn:hover::after, .save-btn:hover::after, .cancel-btn:hover::after {
      opacity: 1;
    }

    .loading::after {
      content: '';
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
      position: absolute;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading {
      pointer-events: none;
      opacity: 0.6;
    }

    .pagination {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 10px 18px;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      background-color: var(--hover);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .pagination button:hover:not(:disabled) {
      background-color: #e2e8f0;
      transform: translateY(-1px);
    }

    .pagination button:disabled {
      background-color: #f1f5f9;
      color: #94a3b8;
      cursor: not-allowed;
      box-shadow: none;
    }

    .pagination button[data-active="true"] {
      background-color: var(--secondary);
      color: white;
      font-weight: 600;
    }

    .pagination button[data-active="true"]:hover {
      background-color: #21867a;
    }

    .flatpickr-input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
    }

    .edit-input, .status-select {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .timeline-container {
      position: relative;
      padding: 20px 0;
      margin-top: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    .timeline-line {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 4px;
      background: linear-gradient(to bottom, #3b82f6, #f59e0b);
      height: 100%;
      border-radius: 2px;
    }

    .timeline-item {
      position: relative;
      margin: 40px 0;
      display: flex;
      align-items: center;
      opacity: 0;
      animation: fadeIn 0.5s ease forwards;
    }

    .timeline-item:nth-child(odd) {
      flex-direction: row;
    }

    .timeline-item:nth-child(even) {
      flex-direction: row-reverse;
    }

    .timeline-bubble {
      width: 300px;
      padding: 15px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative;
      border: 2px solid;
      transition: transform 0.3s ease;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .timeline-bubble.started {
      border-color: #3b82f6;
    }

    .timeline-bubble.completed {
      border-color: #f59e0b;
    }

    .timeline-bubble:hover {
      transform: scale(1.02);
    }

    .timeline-bubble .icon {
      font-size: 20px;
      margin-top: 5px;
    }

    .timeline-bubble.started .icon {
      color: #3b82f6;
    }

    .timeline-bubble.completed .icon {
      color: #f59e0b;
    }

    .timeline-bubble .content {
      flex: 1;
    }

    .timeline-bubble h4 {
      margin: 0 0 10px;
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }

    .timeline-bubble p {
      margin: 5px 0;
      font-size: 14px;
    }

    .timeline-bubble p strong {
      display: inline-block;
      min-width: 100px;
      font-weight: 500;
    }

    .timeline-connector {
      flex: 1;
      height: 2px;
      background: #94a3b8;
      position: relative;
    }

    .timeline-connector::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: #94a3b8;
      border-radius: 50%;
      top: 50%;
      transform: translateY(-50%);
    }

    .timeline-item:nth-child(odd) .timeline-connector::after {
      right: -7px;
    }

    .timeline-item:nth-child(even) .timeline-connector::after {
      left: -7px;
    }

    .timeline-item:nth-child(odd) .timeline-bubble {
      margin-right: 20px;
    }

    .timeline-item:nth-child(even) .timeline-bubble {
      margin-left: 20px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 15px;
      }
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .controls select,
      .controls input,
      .controls textarea,
      .controls button {
        min-width: 100%;
      }
      header {
        padding: 10px 20px;
      }
      header h1 {
        font-size: 20px;
      }
      header img {
        height: 40px;
      }
      .kanban-board {
        flex-direction: column;
      }
      .kanban-column {
        min-width: 100%;
      }
      .timeline-container {
        padding: 10px 0;
      }
      .timeline-line {
        left: 20px;
        transform: none;
      }
      .timeline-item {
        flex-direction: row !important;
        margin: 20px 0;
      }
      .timeline-bubble {
        width: calc(100% - 40px);
        margin-left: 40px !important;
        margin-right: 0 !important;
      }
      .timeline-connector {
        width: 20px;
      }
      .timeline-connector::after {
        left: -7px !important;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="images/logo.png" alt="Logo" onerror="this.src='https://via.placeholder.com/50';">
    <h1>QA Team Kanban Board</h1>
  </header>

  <div class="container">
    <div class="error-message hidden" id="errorMessage"></div>

    <div class="controls" id="adminControls">
      <select id="qaAssignee">
        <option value="">Select QA Member</option>
        <option value="Aswathi">Aswathi</option>
        <option value="Minnu">Minnu</option>
        <option value="Abhiram">Abhiram</option>
      </select>
      <input type="text" id="projectName" placeholder="Project Name">
      <input type="text" id="testingPhase" placeholder="Phase">
      <textarea id="projectDetails" placeholder="Project Details"></textarea>
      <input type="text" id="startDate" placeholder="Start Date">
      <input type="text" id="startTime" placeholder="Start Time (e.g., 09:30)">
      <input type="text" id="dueDate" placeholder="Expected Due Date">
      <input type="text" id="endTime" placeholder="End Time (e.g., 14:00)">
      <input type="number" id="workHours" placeholder="Expected Work Hours">
      <input type="text" id="bugTracker" placeholder="Bug Tracker">
      <select id="ktStatus">
        <option value="">Select KT Status</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
      <button onclick="addTask()">Create Task</button>
      <button class="reset-btn" onclick="resetTaskForm()">Reset Form</button>
    </div>

    <div class="kanban-board" id="kanbanBoard">
      <div class="kanban-column" data-status="todo">
        <h3>To Do</h3>
        <div class="kanban-row" data-qa="Aswathi">
          <h4>Steve</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Minnu">
          <h4>Minnu</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Abhiram">
          <h4>Abhiram</h4>
          <div class="kanban-tasks"></div>
        </div>
      </div>
      <div class="kanban-column" data-status="inprogress">
        <h3>In Progress</h3>
        <div class="kanban-row" data-qa="Aswathi">
          <h4>Steve</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Minnu">
          <h4>Minnu</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Abhiram">
          <h4>Abhiram</h4>
          <div class="kanban-tasks"></div>
        </div>
      </div>
      <div class="kanban-column" data-status="completed">
        <h3>Completed</h3>
        <div class="kanban-row" data-qa="Aswathi">
          <h4>Steve</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Minnu">
          <h4>Minnu</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Abhiram">
          <h4>Abhiram</h4>
          <div class="kanban-tasks"></div>
        </div>
      </div>
      <div class="kanban-column date-column" data-status="date">
        <h3>Date</h3>
        <div class="kanban-row" data-qa="Aswathi">
          <h4>Steve</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Minnu">
          <h4>Minnu</h4>
          <div class="kanban-tasks"></div>
        </div>
        <div class="kanban-row" data-qa="Abhiram">
          <h4>Abhiram</h4>
          <div class="kanban-tasks"></div>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table id="kanbanTable">
        <thead>
          <tr>
            <th>Project Name</th>
            <th>QA Name</th>
            <th>Phase</th>
            <th>Project Details</th>
            <th>Start Date</th>
            <th>Start Time</th>
            <th>Expected Due Date</th>
            <th>End Time</th>
            <th>Expected Work Hours</th>
            <th>Bug Tracker</th>
            <th>KT Status</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="pagination" id="kanbanPagination"></div>

    <div class="report-section" id="reportSection">
      <h3>Task Report</h3>
      <div class="controls">
        <select id="reportMonth" onchange="generateReport()">
          <option value="">Select Month</option>
        </select>
        <select id="reportQA" onchange="generateReport()">
          <option value="">Select QA Member</option>
          <option value="Aswathi">Aswathi</option>
          <option value="Minnu">Minnu</option>
          <option value="Abhiram">Abhiram</option>
        </select>
        <button onclick="exportReportToExcel()">Export Report</button>
      </div>
      <div class="table-container">
        <table id="reportTable">
          <thead>
            <tr>
              <th>Project Name</th>
              <th>QA Name</th>
              <th>Phase</th>
              <th>Project Details</th>
              <th>Start Date</th>
              <th>Start Time</th>
              <th>Expected Due Date</th>
              <th>End Time</th>
              <th>Expected Work Hours</th>
              <th>Bug Tracker</th>
              <th>KT Status</th>
              <th>Status</th>
              <th>Tasks Completed</th>
              <th>Actual End Date</th>
              <th>Actual End Time</th>
              <th>Deviation Time</th>
              <th>Deviation Reasons</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="pagination" id="reportPagination"></div>
      <canvas id="taskChart" height="100"></canvas>
      <div id="taskTimeline" class="timeline-container"></div>
    </div>
  </div>

  <script>
    // Handle script load errors
    function handleScriptLoadError(scriptName) {
      console.error(`${scriptName} failed to load.`);
      showError(`${scriptName} failed to load. Please check your network connection and refresh the page. If running locally, use a web server (e.g., 'python -m http.server 8000').`);
    }

    // Initialize Supabase client with a retry mechanism
    let supabase = null;
    async function initializeSupabase() {
      try {
        if (typeof window.supabase !== 'undefined') {
          supabase = window.supabase.createClient(
            'https://zgrovufqqhawrjgjdnrq.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpncm92dWZxcWhhd3JqZ2pkbnJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0NTMzNDAsImV4cCI6MjA2NTAyOTM0MH0.jBtzJFwAmpai0V2NyMuCdOVCLuIn70bSkLtJ-_3rJjo'
          );
          console.log('Supabase initialized successfully');
          return true;
        } else {
          console.error('Supabase library not loaded.');
          return false;
        }
      } catch (error) {
        console.error('Supabase initialization failed:', error);
        return false;
      }
    }

    // Global variables
    let taskChartInstance = null;
    let allTasks = [];
    const rowsPerPage = 10;
    let currentPage = 1;
    let reportCurrentPage = 1;
    let datepickers = [];
    let timepickers = [];

    // Show error message
    function showError(message) {
      const errorMessage = document.getElementById('errorMessage');
      if (errorMessage) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
        setTimeout(() => errorMessage.classList.add('hidden'), 5000);
      } else {
        console.error('Error message element not found:', message);
      }
    }

    // Hide error message
    function hideError() {
      const errorMessage = document.getElementById('errorMessage');
      if (errorMessage) {
        errorMessage.classList.add('hidden');
      }
    }

    // Get current date in YYYY-MM-DD format (IST)
    function getCurrentDate() {
      const today = new Date();
      return today.toLocaleDateString('en-CA', { timeZone: 'Asia/Kolkata' }); // YYYY-MM-DD format
    }

    // Get current time in HH:mm format (IST)
    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString('en-GB', { 
        timeZone: 'Asia/Kolkata', 
        hour: '2-digit', 
        minute: '2-digit', 
        hour12: false 
      });
    }

    // Validate date format (YYYY-MM-DD)
    function validateDateFormat(date) {
      const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (!dateRegex.test(date)) return false;
      const parsedDate = new Date(date);
      return !isNaN(parsedDate.getTime());
    }

    // Check if a task is overdue
    function isTaskOverdue(task) {
      if (task.status === 'completed') return false;
      try {
        const due = new Date(`${task.dueDate}T${task.endTime}:00+05:30`); // IST offset
        const now = new Date();
        now.setTime(now.getTime() + (5.5 * 60 * 60 * 1000)); // Adjust to IST
        return due < now;
      } catch (error) {
        console.error('Error checking overdue status:', error);
        return false;
      }
    }

    // Calculate deviation time
    function calculateDeviationTime(dueDate, endTime, actualEndDate, actualEndTime) {
      if (!actualEndDate || !actualEndTime) return '0 hours';
      try {
        const expected = new Date(`${dueDate}T${endTime}:00+05:30`);
        const actual = new Date(`${actualEndDate}T${actualEndTime}:00+05:30`);
        const diffMs = actual - expected;
        if (diffMs <= 0) return '0 hours';
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours} hours ${minutes} minutes`;
      } catch (error) {
        console.error('Error calculating deviation time:', error);
        return 'Error';
      }
    }

    // Fallback for copying text to clipboard
    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          document.body.removeChild(textarea);
          return Promise.resolve();
        } catch (error) {
          document.body.removeChild(textarea);
          return Promise.reject(error);
        }
      }
    }

    // Initialize app on DOM load
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (typeof window.flatpickr === 'undefined') {
          console.warn('Flatpickr not loaded. Date and time pickers will be disabled.');
          showError('Date picker library failed to load. You can still enter dates manually (YYYY-MM-DD) and times (HH:mm).');
        } else {
          const startDate = document.getElementById('startDate');
          const dueDate = document.getElementById('dueDate');
          const startTime = document.getElementById('startTime');
          const endTime = document.getElementById('endTime');

          if (startDate) datepickers.push(flatpickr(startDate, { dateFormat: 'Y-m-d', allowInput: true }));
          if (dueDate) datepickers.push(flatpickr(dueDate, { dateFormat: 'Y-m-d', allowInput: true }));
          if (startTime) timepickers.push(flatpickr(startTime, { enableTime: true, noCalendar: true, dateFormat: 'H:i', time_24hr: true, allowInput: true }));
          if (endTime) timepickers.push(flatpickr(endTime, { enableTime: true, noCalendar: true, dateFormat: 'H:i', time_24hr: true, allowInput: true }));
        }
        
        populateMonthFilter();
        await loadTasksFromSupabase();
      } catch (error) {
        console.error('DOM Content Loaded error:', error);
        showError('Initialization error. Please refresh the page.');
      }
    });

    // Populate month filter
    function populateMonthFilter() {
      const select = document.getElementById('reportMonth');
      if (!select) return;
      const months = [];
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 1; year <= currentYear + 1; year++) {
        for (let month = 1; month <= 12; month++) {
          const date = new Date(year, month - 1);
          months.push({
            value: `${year}-${month.toString().padStart(2, '0')}`,
            text: date.toLocaleString('default', { month: 'long', year: 'numeric' })
          });
        }
      }
      months.forEach(m => {
        const option = document.createElement('option');
        option.value = m.value;
        option.textContent = m.text;
        select.appendChild(option);
      });
    }

    // Reset task form
    function resetTaskForm() {
      const fields = [
        'qaAssignee', 'projectName', 'testingPhase', 'projectDetails',
        'startDate', 'startTime', 'dueDate', 'endTime',
        'workHours', 'bugTracker', 'ktStatus'
      ];
      fields.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = '';
      });
      datepickers.forEach(dp => dp.clear());
      timepickers.forEach(tp => tp.clear());
    }

    // Load tasks from Supabase
    async function loadTasksFromSupabase() {
      try {
        if (!supabase) {
          const initialized = await initializeSupabase();
          if (!initialized) {
            showError('Unable to connect to database. Please try again.');
            return;
          }
        }
        const { data, error } = await supabase
          .from('qa_tasks')
          .select('*')
          .order('timestamp', { ascending: false });

        if (error) {
          console.error('Load tasks error:', error);
          showError('Error loading tasks: ' + error.message);
          return;
        }

        allTasks = data.map(task => ({
          taskId: task.id,
          qaAssignee: task.qa_assignee,
          projectName: task.project_name,
          testingPhase: task.testing_phase,
          projectDetails: task.project_details,
          startDate: task.start_date,
          startTime: task.start_time,
          dueDate: task.due_date,
          endTime: task.end_time,
          workHours: task.work_hours,
          bugTracker: task.bug_tracker,
          ktStatus: task.kt_status,
          status: task.status,
          tasksCompleted: task.tasks_completed,
          actualEndDate: task.actual_end_date,
          actualEndTime: task.actual_end_time,
          deviationTime: task.deviation_time,
          deviationReasons: task.deviation_reasons,
          timestamp: task.timestamp
        }));

        renderKanbanBoard();
        renderKanbanTable();
        generateReport();
        setupDragAndDrop();
      } catch (error) {
        console.error('Load tasks error:', error);
        showError('Failed to load tasks from database. Please check your network.');
      }
    }

    // Validate time format (HH:mm)
    function validateTimeFormat(time) {
      const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
      return timeRegex.test(time);
    }

    // Add new task
    async function addTask() {
      const qaAssignee = document.getElementById('qaAssignee')?.value;
      const projectName = document.getElementById('projectName')?.value;
      const testingPhase = document.getElementById('testingPhase')?.value;
      const projectDetails = document.getElementById('projectDetails')?.value;
      const startDate = document.getElementById('startDate')?.value;
      const startTime = document.getElementById('startTime')?.value;
      const dueDate = document.getElementById('dueDate')?.value;
      const endTime = document.getElementById('endTime')?.value;
      const workHours = document.getElementById('workHours')?.value;
      const bugTracker = document.getElementById('bugTracker')?.value;
      const ktStatus = document.getElementById('ktStatus')?.value;

      if (!qaAssignee || !projectName || !startDate || !startTime || !dueDate || !endTime || !workHours || !ktStatus || !projectDetails) {
        showError('Please fill in all required fields.');
        return;
      }

      if (!validateDateFormat(startDate) || !validateDateFormat(dueDate)) {
        showError('Start Date and Due Date must be in YYYY-MM-DD format.');
        return;
      }

      if (!validateTimeFormat(startTime) || !validateTimeFormat(endTime)) {
        showError('Start Time and End Time must be in HH:mm format (e.g., 09:30).');
        return;
      }

      try {
        if (!supabase) {
          const initialized = await initializeSupabase();
          if (!initialized) {
            showError('Unable to connect to database. Please try again.');
            return;
          }
        }
        const timestamp = new Date().toISOString();
        const taskData = {
          qa_assignee: qaAssignee,
          project_name: projectName,
          testing_phase: testingPhase,
          project_details: projectDetails,
          start_date: startDate,
          start_time: startTime,
          due_date: dueDate,
          end_time: endTime,
          work_hours: parseInt(workHours),
          bug_tracker: bugTracker,
          kt_status: ktStatus,
          status: 'todo',
          tasks_completed: null,
          actual_end_date: null,
          actual_end_time: null,
          deviation_time: null,
          deviation_reasons: null,
          timestamp: timestamp
        };

        const { error } = await supabase
          .from('qa_tasks')
          .insert([taskData]);

        if (error) {
          console.error('Add task error:', error);
          showError('Error creating task: ' + error.message);
          return;
        }

        alert('Task created successfully!');
        generateWorkScheduleMessage({
          ...taskData,
          qaAssignee,
          projectName,
          startDate,
          startTime,
          endTime,
          ktStatus
        });
        resetTaskForm();
        await loadTasksFromSupabase();
      } catch (error) {
        console.error('Add task error:', error);
        showError('Failed to create task. Please check your network.');
      }
    }

    // Generate Work Schedule message
    function generateWorkScheduleMessage(task) {
      try {
        const startDate = new Date(task.startDate);
        const taskCount = allTasks.filter(t => t.qaAssignee === task.qaAssignee && t.startDate === task.startDate && t.status !== 'completed').length + 1;
        const message = `
${task.qaAssignee}, ${startDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', timeZone: 'Asia/Kolkata' })}, ${task.startTime}-${task.endTime}
Project: ${task.projectName}
KT Status: ${task.ktStatus}
No of tasks: ${taskCount}
Time: Start: ${task.startTime} End: ${task.endTime}
        `;
        copyToClipboard(message).then(() => {
          alert('Work Schedule message copied to clipboard!');
        }).catch(error => {
          console.error('Clipboard error:', error);
          showError('Failed to copy schedule message.');
        });
      } catch (error) {
        console.error('Generate schedule message error:', error);
        showError('Error generating schedule message.');
      }
    }

    // Generate Work Completion message
    function generateWorkCompletionMessage(task) {
      try {
        const startDate = new Date(task.startDate);
        const message = `
${task.qaAssignee}, ${startDate.toLocaleDateString('en-US', { day: 'numeric', month: 'short', timeZone: 'Asia/Kolkata' })}, ${task.startTime}-${task.endTime}
Project: ${task.projectName}
Tasks Completed: ${task.tasksCompleted || 'N/A'}
Time: Start: ${task.startTime} End: ${task.actualEndTime || task.endTime}
Deviation Time: ${task.deviationTime || '0 hours'}
Deviation Reasons: ${task.deviationReasons || 'None'}
        `;
        copyToClipboard(message).then(() => {
          alert('Work completion message copied to clipboard!');
        }).catch(error => {
          console.error('Clipboard error:', error);
          showError('Failed to copy completion message.');
        });
      } catch (error) {
        console.error('Generate completion message error:', error);
        showError('Error generating completion message.');
      }
    }

    // Render Kanban Board
    function renderKanbanBoard() {
      try {
        const columns = document.querySelectorAll('.kanban-column');
        if (!columns) return;

        columns.forEach(column => {
          const status = column.dataset.status;
          const tasksContainers = column.querySelectorAll('.kanban-tasks');
          tasksContainers.forEach(container => {
            container.innerHTML = '';
            const qa = container.parentElement.dataset.qa;
            const filteredTasks = allTasks.filter(task => task.qaAssignee === qa && (status === 'date' || task.status === status));
            filteredTasks.forEach(task => {
              const card = document.createElement('div');
              card.className = 'kanban-card';
              card.dataset.taskId = task.taskId;
              if (status !== 'date') {
                card.draggable = true;
              }
              card.innerHTML = `
                <p><strong>Project:</strong> ${task.projectName}</p>
                <p><strong>Phase:</strong> ${task.testingPhase || 'N/A'}</p>
                ${status === 'date' ? `<p><strong>Start:</strong> ${task.startDate} ${task.startTime}</p>` : ''}
              `;
              container.appendChild(card);
            });
          });
        });
      } catch (error) {
        console.error('Render Kanban board error:', error);
        showError('Failed to render Kanban board.');
      }
    }

    // Setup drag and drop
    function setupDragAndDrop() {
      let draggedCard = null;

      const dragStartHandler = e => {
        if (e.target.classList.contains('kanban-card') && e.target.closest('.kanban-column:not(.date-column)')) {
          draggedCard = e.target;
          draggedCard.classList.add('dragging');
          setTimeout(() => {
            if (draggedCard) draggedCard.style.display = 'none';
          }, 0);
        }
      };

      const dragEndHandler = () => {
        if (draggedCard) {
          draggedCard.style.display = 'block';
          draggedCard.classList.remove('dragging');
          draggedCard = null;
          document.querySelectorAll('.kanban-column').forEach(col => col.classList.remove('dropzone'));
        }
      };

      document.addEventListener('dragstart', dragStartHandler);
      document.addEventListener('dragend', dragEndHandler);

      document.querySelectorAll('.kanban-column:not(.date-column) .kanban-tasks').forEach(container => {
        container.addEventListener('dragover', e => {
          e.preventDefault();
        });

        container.addEventListener('dragenter', e => {
          e.preventDefault();
          container.closest('.kanban-column').classList.add('dropzone');
        });

        container.addEventListener('dragleave', e => {
          if (e.relatedTarget && !container.contains(e.relatedTarget)) {
            container.closest('.kanban-column').classList.remove('dropzone');
          }
        });

        container.addEventListener('drop', async e => {
          e.preventDefault();
          if (!draggedCard) return;
          const taskId = draggedCard.dataset.taskId;
          const newStatus = container.closest('.kanban-column').dataset.status;
          const newQa = container.parentElement.dataset.qa;
          container.closest('.kanban-column').classList.remove('dropzone');
          container.appendChild(draggedCard);
          await updateTaskStatus(taskId, newStatus, newQa);
        });
      });
    }

    // Render Kanban table
    function renderKanbanTable() {
      try {
        const tableBody = document.querySelector('#kanbanTable tbody');
        if (!tableBody) return;

        tableBody.innerHTML = '';
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedTasks = allTasks.slice(start, end);

        if (paginatedTasks.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="13">No tasks available</td></tr>';
        } else {
          paginatedTasks.forEach(task => {
            const row = document.createElement('tr');
            row.setAttribute('data-taskid', task.taskId);
            const isOverdue = isTaskOverdue(task);
            row.innerHTML = `
              <td class="${isOverdue ? 'overdue' : ''}">${task.projectName}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.qaAssignee}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.testingPhase || ''}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.projectDetails}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.startDate}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.startTime}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.dueDate}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.endTime}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.workHours}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.bugTracker || ''}</td>
              <td class="${isOverdue ? 'overdue' : ''}">${task.ktStatus}</td>
              <td class="${isOverdue ? 'overdue' : ''}">
                <select class="status-select" onchange="updateTaskStatus('${task.taskId}', this.value)">
                  <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                  <option value="inprogress" ${task.status === 'inprogress' ? 'selected' : ''}>In Progress</option>
                  <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
              </td>
              <td class="${isOverdue ? 'overdue' : ''}">
                <button class="edit-btn" onclick="editTask(this)" data-tooltip="Edit Task"><i class="fas fa-edit"></i></button>
                <button class="delete-btn" onclick="deleteTask(this)" data-tooltip="Delete Task"><i class="fas fa-trash"></i></button>
              </td>`;
            tableBody.appendChild(row);
          });
        }

        updateKanbanPagination(allTasks.length);
      } catch (error) {
        console.error('Render Kanban table error:', error);
        showError('Failed to render Kanban table.');
      }
    }

    // Update Kanban pagination
    function updateKanbanPagination(totalRows) {
      try {
        const pagination = document.getElementById('kanbanPagination');
        if (!pagination) return;
        pagination.innerHTML = '';
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        if (totalRows === 0) {
          pagination.innerHTML = '<p>No pages available</p>';
          return;
        }

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => {
          if (currentPage > 1) {
            currentPage--;
            renderKanbanTable();
          }
        };
        pagination.appendChild(prevButton);

        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement('button');
          pageButton.textContent = i;
          pageButton.disabled = i === currentPage;
          if (i === currentPage) {
            pageButton.setAttribute('data-active', 'true');
          }
          pageButton.onclick = () => {
            currentPage = i;
            renderKanbanTable();
          };
          pagination.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => {
          if (currentPage < totalPages) {
            currentPage++;
            renderKanbanTable();
          }
        };
        pagination.appendChild(nextButton);
      } catch (error) {
        console.error('Update pagination error:', error);
        showError('Failed to update pagination.');
      }
    }

    // Update task status
    async function updateTaskStatus(taskId, newStatus, newQa) {
      try {
        if (!supabase) {
          const initialized = await initializeSupabase();
          if (!initialized) {
            showError('Unable to connect to database. Please try again.');
            return;
          }
        }
        const taskIndex = allTasks.findIndex(t => t.taskId === taskId);
        if (taskIndex === -1) {
          showError('Task not found.');
          return;
        }

        const task = allTasks[taskIndex];
        const updates = { 
          status: newStatus,
          timestamp: new Date().toISOString()
        };
        if (newQa && newQa !== task.qaAssignee) {
          updates.qa_assignee = newQa;
          allTasks[taskIndex].qaAssignee = newQa;
        }

        if (newStatus === 'completed') {
          updates.actual_end_date = getCurrentDate();
          updates.actual_end_time = getCurrentTime();
          updates.deviation_time = calculateDeviationTime(task.dueDate, task.endTime, updates.actual_end_date, updates.actual_end_time);
        }

        const { error } = await supabase
          .from('qa_tasks')
          .update(updates)
          .eq('id', taskId);

        if (error) {
          console.error('Update task status error:', error);
          showError('Error updating task status: ' + error.message);
          return;
        }

        await loadTasksFromSupabase();
      } catch (error) {
        console.error('Update task status error:', error);
        showError('Failed to update task status. Please check your network.');
      }
    }

    // Edit task
    function editTask(button) {
      const row = button.closest('tr');
      const taskId = row.dataset.taskId;
      const task = allTasks.find(t => t.taskId === taskId);
      if (!task) {
        showError('Task not found.');
        return;
      }

      row.innerHTML = `
        <td><input class="edit-input" type="text" value="${task.projectName}" data-field="projectName"></td>
        <td><input class="edit-input" type="text" value="${task.qaAssignee}" data-field="qaAssignee"></td>
        <td><input class="edit-input" type="text" value="${task.testingPhase || ''}" data-field="testingPhase"></td>
        <td><input class="edit-input" type="text" value="${task.projectDetails}" data-field="projectDetails"></td>
        <td><input class="edit-input" type="date" value="${task.startDate}" data-field="startDate"></td>
        <td><input class="edit-input" type="time" value="${task.startTime}" data-field="startTime"></td>
        <td><input class="edit-input" type="date" value="${task.dueDate}" data-field="dueDate"></td>
        <td><input class="edit-input" type="time" value="${task.endTime}" data-field="endTime"></td>
        <td><input class="edit-input" type="number" value="${task.workHours}" data-field="workHours"></td>
        <td><input class="edit-input" type="text" value="${task.bugTracker || ''}" data-field="bugTracker"></td>
        <td>
          <select class="edit-input" data-field="ktStatus">
            <option value="Yes" ${task.ktStatus === 'Yes' ? 'selected' : ''}>Yes</option>
            <option value="No" ${task.ktStatus === 'No' ? 'selected' : ''}>No</option>
          </select>
        </td>
        <td>
          <select class="edit-input" data-field="status">
            <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
            <option value="inprogress" ${task.status === 'inprogress' ? 'selected' : ''}>In Progress</option>
            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
          </select>
        </td>
        <td>
          <button class="save-btn" onclick="saveTaskEdit(this, '${task.taskId}')" data-tooltip="Save"><i class="fas fa-save"></i></button>
          <button class="cancel-btn" onclick="cancelTaskEdit(this)" data-tooltip="Cancel"><i class="fas fa-times"></i></button>
        </td>
      `;
    }

    // Save task edit
    async function saveTaskEdit(button, taskId) {
      const row = button.closest('tr');
      const inputs = row.querySelectorAll('.edit-input');
      const updates = {};

      inputs.forEach(input => {
        const field = input.dataset.field;
        updates[field] = input.value;
      });

      if (!validateDateFormat(updates.startDate) || !validateDateFormat(updates.dueDate)) {
        showError('Start Date and Due Date must be in YYYY-MM-DD format.');
        return;
      }

      if (!validateTimeFormat(updates.startTime) || !validateTimeFormat(updates.endTime)) {
        showError('Start Time and End Time must be in HH:mm format (e.g., 09:30).');
        return;
      }

      try {
        if (!supabase) {
          const initialized = await initializeSupabase();
          if (!initialized) {
            showError('Unable to connect to database. Please try again.');
            return;
          }
        }
        const { error } = await supabase
          .from('qa_tasks')
          .update({
            project_name: updates.projectName,
            qa_assignee: updates.qaAssignee,
            testing_phase: updates.testingPhase,
            project_details: updates.projectDetails,
            start_date: updates.startDate,
            start_time: updates.startTime,
            due_date: updates.dueDate,
            end_time: updates.endTime,
            work_hours: parseInt(updates.workHours),
            bug_tracker: updates.bugTracker,
            kt_status: updates.ktStatus,
            status: updates.status,
            actual_end_date: updates.actual_end_date || null,
            actual_end_time: updates.actual_end_time || null,
            deviation_time: updates.deviationTime || null,
            timestamp: new Date().toISOString()
          })
          .eq('id', taskId);

        if (error) {
          console.error('Save task edit error:', error);
          showError('Error updating task: ' + error.message);
          return;
        }

        await loadTasksFromSupabase();
      } catch (error) {
        console.error('Save task edit error:', error);
        showError('Failed to save task. Please check your network.');
      }
    }

    // Cancel task edit
    function cancelTaskEdit() {
      renderKanbanTable();
    }

    // Delete task
    async function deleteTask(button) {
      if (!confirm('Are you sure you want to delete this task?')) return;

      const row = button.closest('tr');
      const taskId = row.dataset.taskId;

      try {
        if (!supabase) {
          const initialized = await initializeSupabase();
          if (!initialized) {
            showError('Unable to connect to database. Please try again.');
            return;
          }
        }
        const { error } = await supabase
          .from('qa_tasks')
          .delete()
          .eq('id', taskId);

        if (error) {
          console.error('Delete task error:', error);
          showError('Error deleting task: ' + error.message);
          return;
        }

        await loadTasksFromSupabase();
      } catch (error) {
        console.error('Delete task error:', error);
        showError('Failed to delete task. Please check your network.');
      }
    }

    // Generate report
    function generateReport() {
      try {
        const month = document.getElementById('reportMonth')?.value;
        const qa = document.getElementById('reportQA')?.value;
        let filteredTasks = allTasks;

        if (month) {
          filteredTasks = filteredTasks.filter(task => task.startDate && task.startDate.startsWith(month));
        }
        if (qa) {
          filteredTasks = filteredTasks.filter(task => task.qaAssignee === qa);
        }

        renderReportTable(filteredTasks);
        updateTaskChart(filteredTasks);
        updateTaskTimeline(filteredTasks);
      } catch (error) {
        console.error('Generate report error:', error);
        showError('Failed to generate report.');
      }
    }

    // Render report table
    function renderReportTable(tasks) {
      try {
        const tableBody = document.querySelector('#reportTable tbody');
        if (!tableBody) return;

        tableBody.innerHTML = '';
        const start = (reportCurrentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedTasks = tasks.slice(start, end);

        if (paginatedTasks.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="18">No tasks available</td></tr>';
        } else {
          paginatedTasks.forEach(task => {
            const row = document.createElement('tr');
            row.setAttribute('data-taskid', task.taskId);
            row.innerHTML = `
              <td>${task.projectName || ''}</td>
              <td>${task.qaAssignee || ''}</td>
              <td>${task.testingPhase || ''}</td>
              <td>${task.projectDetails || ''}</td>
              <td>${task.startDate || ''}</td>
              <td>${task.startTime || ''}</td>
              <td>${task.dueDate || ''}</td>
              <td>${task.endTime || ''}</td>
              <td>${task.workHours || '-'}</td>
              <td>${task.bugTracker || ''}</td>
              <td>${task.ktStatus || ''}</td>
              <td>${task.status || ''}</td>
              <td><input class="edit-input" type="number" value="${task.tasksCompleted || ''}" data-field="tasksCompleted" autocomplete="off"></td>
              <td><input class="edit-input" type="date" value="${task.actualEndDate || ''}" data-field="actualEndDate"></td>
              <td><input class="edit-input" type="time" value="${task.actualEndTime || ''}" data-field="actualEndTime" autocomplete="off"></td>
              <td>${task.deviationTime || '-'}</td>
              <td><input class="edit-input" type="text" value="${task.deviationReasons || ''}" data-field="deviationReasons" autocomplete="off"></td>
              <td>
                <button class="save-btn" onclick="saveReportEdit(this, '${task.taskId}')" data-tooltip="Save"><i class="fas fa-save"></i></button>
                <button class="edit-btn" onclick="generateWorkCompletionMessage(allTasks.find(t => t.taskId === '${task.taskId}'))" data-tooltip="Generate Completion"><i class="fas fa-copy"></i></button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        }

        updateReportPagination(tasks.length);
      } catch (error) {
        console.error('Render report table error:', error);
        showError('Failed to render report table.');
      }
    }

    // Save report edit
    async function saveReportEdit(button, taskId) {
      const row = button.closest('tr');
      const inputs = row.querySelectorAll('.edit-input');
      const updates = {};

      inputs.forEach(input => {
        const field = input.dataset.field;
        updates[field] = input.value || null;
      });

      if (updates.actualEndDate && !validateDateFormat(updates.actualEndDate)) {
        showError('Actual End Date must be in YYYY-MM-DD format.');
        return;
      }

      if (updates.actualEndTime && !validateTimeFormat(updates.actualEndTime)) {
        showError('Actual End Time must be in HH:mm format (e.g., 14:00).');
        return;
      }

      const task = allTasks.find(t => t.taskId === taskId);
      if (updates.actualEndDate && updates.actualEndTime && task) {
        updates.deviationTime = calculateDeviationTime(
          task.dueDate,
          task.endTime,
          updates.actualEndDate,
          updates.actualEndTime
        );
      }

      try {
        if (!supabase) {
          const initialized = await initializeSupabase();
          if (!initialized) {
            showError('Unable to connect to database. Please try again.');
            return;
          }
        }
        const { error } = await supabase
          .from('qa_tasks')
          .update({
            tasks_completed: updates.tasksCompleted ? parseInt(updates.tasksCompleted) : null,
            actual_end_date: updates.actualEndDate,
            actual_end_time: updates.actualEndTime,
            deviation_time: updates.deviationTime,
            deviation_reasons: updates.deviationReasons,
            timestamp: new Date().toISOString()
          })
          .eq('id', taskId);

        if (error) {
          console.error('Save report error:', error);
          showError('Error saving report: ' + error.message);
          return;
        }

        await loadTasksFromSupabase();
      } catch (error) {
        console.error('Save report edit error:', error);
        showError('Failed to save report. Please check your network.');
      }
    }

    // Update report pagination
    function updateReportPagination(totalRows) {
      try {
        const pagination = document.getElementById('reportPagination');
        if (!pagination) return;
        pagination.innerHTML = '';
        const totalPages = Math.ceil(totalRows / rowsPerPage);

        if (totalRows === 0) {
          pagination.innerHTML = '<p>No pages available</p>';
          return;
        }

        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.disabled = reportCurrentPage === 1;
        prevButton.onclick = () => {
          if (reportCurrentPage > 1) {
            reportCurrentPage--;
            generateReport();
          }
        };
        pagination.appendChild(prevButton);

        for (let i = 1; i <= totalPages; i++) {
          const pageButton = document.createElement('button');
          pageButton.textContent = i;
          pageButton.disabled = i === reportCurrentPage;
          if (i === reportCurrentPage) {
            pageButton.setAttribute('data-active', 'true');
          }
          pageButton.onclick = () => {
            reportCurrentPage = i;
            generateReport();
          };
          pagination.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.disabled = reportCurrentPage === totalPages;
        nextButton.onclick = () => {
          if (reportCurrentPage < totalPages) {
            reportCurrentPage++;
            generateReport();
          }
        };
        pagination.appendChild(nextButton);
      } catch (error) {
        console.error('Update report pagination error:', error);
        showError('Failed to update report pagination.');
      }
    }

    // Update task chart
    function updateTaskChart(tasks) {
      try {
        if (typeof window.Chart === 'undefined' || !tasks) {
          console.warn('Chart.js not loaded or tasks is null. Chart will not be displayed.');
          return;
        }
        const ctx = document.getElementById('taskChart');
        if (!ctx) return;

        if (taskChartInstance) {
          taskChartInstance.destroy();
          taskChartInstance = null;
        }

        const statusCounts = tasks.reduce((acc, task) => {
          acc[task.status] = (acc[task.status] || 0) + 1;
          return acc;
        }, { todo: 0, inprogress: 0, completed: 0 });

        taskChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['To Do', 'In Progress', 'Completed'],
            datasets: [{
              label: 'Tasks',
              data: [statusCounts.todo, statusCounts.inprogress, statusCounts.completed],
              backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Update task chart error:', error);
        showError('Failed to update task chart.');
      }
    }

    // Update task timeline
    function updateTaskTimeline(tasks) {
      try {
        const timeline = document.getElementById('taskTimeline');
        if (!timeline) return;
        timeline.innerHTML = '<div class="timeline-line"></div>';

        const timelineTasks = tasks
          .filter(task => task.status === 'completed')
          .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        timelineTasks.forEach((task, index) => {
          const item = document.createElement('div');
          item.className = 'timeline-item';
          item.style.animationDelay = `${index * 0.2}s`;

          const endDateLabel = task.actualEndDate ? 'Actual End' : 'Expected End';
          const endDateValue = task.actualEndDate || task.dueDate;
          const endTimeValue = task.actualEndTime || task.endTime;

          const bubble = document.createElement('div');
          bubble.className = `timeline-bubble ${task.status === 'completed' ? 'completed' : 'started'}`;
          bubble.innerHTML = `
            <span class="icon"><i class="fas fa-${task.status === 'completed' ? 'check-circle' : 'play-circle'}"></i></span>
            <div class="content">
              <h4>${task.projectName}</h4>
              <p><strong>QA:</strong> ${task.qaAssignee}</p>
              <p><strong>Start:</strong> ${task.startDate} ${task.startTime}</p>
              <p><strong>${endDateLabel}:</strong> ${endDateValue} ${endTimeValue}</p>
              <p><strong>Status:</strong> ${task.status}</p>
            </div>
          `;

          const connector = document.createElement('div');
          connector.className = 'timeline-connector';

          item.appendChild(bubble);
          item.appendChild(connector);
          timeline.appendChild(item);
        });
      } catch (error) {
        console.error('Update task timeline error:', error);
        showError('Failed to update task timeline.');
      }
    }

    // Export report to Excel
    function exportReportToExcel() {
      try {
        if (typeof window.XLSX === 'undefined') {
          console.warn('XLSX library not loaded. Export functionality disabled.');
          showError('Excel export library failed to load.');
          return;
        }

        const month = document.getElementById('reportMonth')?.value;
        const qa = document.getElementById('reportQA')?.value;
        let filteredTasks = allTasks;

        if (month) {
          filteredTasks = filteredTasks.filter(task => task.startDate && task.startDate.startsWith(month));
        }
        if (qa) {
          filteredTasks = filteredTasks.filter(task => task.qaAssignee === qa);
        }

        const data = filteredTasks.map(task => ({
          'Project Name': task.projectName || '',
          'QA Name': task.qaAssignee || '',
          'Phase': task.testingPhase || '',
          'Project Details': task.projectDetails || '',
          'Start Date': task.startDate || '',
          'Start Time': task.startTime || '',
          'Expected Due Date': task.dueDate || '',
          'End Time': task.endTime || '',
          'Expected Work Hours': task.workHours || '-',
          'Bug Tracker': task.bugTracker || '',
          'KT Status': task.ktStatus || '',
          'Status': task.status || '',
          'Tasks Completed': task.tasksCompleted || '',
          'Actual End Date': task.actualEndDate || '',
          'Actual End Time': task.actualEndTime || '',
          'Deviation Time': task.deviationTime || '',
          'Deviation Reasons': task.deviationReasons || ''
        }));

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'QA Report');

        // Auto-size columns
        const colWidths = Object.keys(data[0] || {}).map((key, i) => {
          const maxLength = Math.max(
            key.length,
            ...data.map(row => (row[key] || '').toString().length)
          );
          return { wch: Math.min(maxLength + 5, 50) }; // Increased padding
        });
        worksheet['!cols'] = colWidths;

        // Generate filename with timestamp (IST)
        const now = new Date();
        const timestamp = now.toLocaleString('en-GB', {
          timeZone: 'Asia/Kolkata',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        }).replace(/[,:/ ]/g, '-');
        const filename = `QA-Report-${timestamp}.xlsx`;

        // Write and download the file
        XLSX.writeFile(workbook, filename);
        alert('Report exported successfully!');
      } catch (error) {
        console.error('Export to Excel error:', error);
        showError('Failed to export report to Excel.');
      }
    }
  </script>
</body>
</html>
